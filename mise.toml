[tools]
hcloud = "latest"
packer = "latest"
terraform = "latest"
talosctl = "latest"
kubectl = "latest"

[env]
TF_VAR_hcloud_token="MtM9Oq1m0t1H2pjWhWL1y9TDFnybWOoZfPxtibtC57COWYQoKshAE7F7YX09GgyG"

# =============================================================================
# Toolbox Tasks
# =============================================================================

[tasks.build-toolboxes]
alias = "bt"
description = "Build all toolbox container images"
run = """podman build --file $HOME/.infra-env/toolboxes/infra/Dockerfile --tag localhost/toolbox-infra:latest $HOME/.infra-env/toolboxes/infra && \
podman build --file $HOME/.infra-env/toolboxes/cka/Dockerfile --tag localhost/toolbox-cka:latest $HOME/.infra-env/toolboxes/cka && \
podman build --file $HOME/.infra-env/toolboxes/dev/Dockerfile --tag localhost/toolbox-dev:latest $HOME/.infra-env/toolboxes/dev"""

[tasks.create-toolboxes]
alias = "ct"
description = "Create all toolboxes idempotently (builds images first)"
depends = ["build-toolboxes"]
run = """toolbox create --container-name infra --image localhost/toolbox-infra:latest 2>/dev/null || echo "infra toolbox already exists" && \
toolbox create --container-name cka --image localhost/toolbox-cka:latest 2>/dev/null || echo "cka toolbox already exists" && \
toolbox create --container-name dev --image localhost/toolbox-dev:latest 2>/dev/null || echo "dev toolbox already exists""""

[tasks.enter-infra]
alias = "ei"
description = "Enter the infra toolbox"
run = "toolbox enter infra"

[tasks.enter-cka]
alias = "ec"
description = "Enter the cka toolbox"
run = "toolbox enter cka"

[tasks.enter-dev]
alias = "ed"
description = "Enter the dev toolbox"
run = "toolbox enter dev"

# =============================================================================
# Terraform Tasks - Staging (HCloud)
# =============================================================================

[tasks.tf-init-staging]
alias = "tfs"
description = "Initialize Terraform for staging environment"
dir = "infra/terraform/environments/staging"
run = "terraform init"

[tasks.tf-plan-staging]
alias = "tfps"
description = "Run Terraform plan for staging environment"
dir = "infra/terraform/environments/staging"
run = "terraform plan"

[tasks.tf-apply-staging]
alias = "tfas"
description = "Apply Terraform for staging environment"
dir = "infra/terraform/environments/staging"
run = "terraform apply"

[tasks.tf-destroy-staging]
alias = "tfds"
description = "Destroy Terraform for staging environment"
dir = "infra/terraform/environments/staging"
run = "terraform destroy"


[tasks.get-configs-staging]
alias = "gcs"
description = "Get kubeconfig and talosconfig for staging"
dir = "infra/terraform/environments/staging"
run = """terraform output -raw kubeconfig > ~/.kube/config-stg && terraform output -raw talosconfig > talosconfig && \
export KUBECONFIG="$(pwd)/kubeconfig" && \
export TALOSCONFIG="$(pwd)/talosconfig" && \
echo "" && \
echo "âœ… Configs retrieved and exported for this session" && \
echo "" && \
echo "To use in your current shell, run:" && \
echo "  export KUBECONFIG=\"$(pwd)/kubeconfig\"" && \
echo "  export TALOSCONFIG=\"$(pwd)/talosconfig\"""""

# =============================================================================
# Terraform Tasks - Production (Proxmox)
# =============================================================================

[tasks.tf-init-prod]
alias = "tfp"
description = "Initialize Terraform for production environment"
dir = "infra/terraform/environments/prod"
run = "terraform init"

[tasks.tf-plan-prod]
alias = "tfpp"
description = "Run Terraform plan for production environment"
dir = "infra/terraform/environments/prod"
run = "terraform plan"

[tasks.tf-apply-prod]
alias = "tfap"
description = "Apply Terraform for production environment"
dir = "infra/terraform/environments/prod"
run = "terraform apply"

[tasks.get-configs-prod]
alias = "gcp"
description = "Get kubeconfig and talosconfig for production"
dir = "infra/terraform/environments/prod"
run = '''
terraform output -raw kubeconfig > ~/.kube/config-prod && terraform output -raw talosconfig > talosconfig
export KUBECONFIG="$(pwd)/kubeconfig
export TALOSCONFIG="$(pwd)/talosconfig
'''
# =============================================================================
# Packer Tasks
# =============================================================================

[tasks.packer-build-proxmox]
alias = "pb"
description = "Build Proxmox template with Packer"
dir = "packer"
run = "packer build -only=proxmox* ."

# =============================================================================
# Cleanup Tasks
# =============================================================================

[tasks.clean-tf]
alias = "clean"
description = "Clean Terraform state files and directories"
run = """find terraform -type d -name '.terraform' -exec rm -rf {} + 2>/dev/null || true && \
find terraform -name '.terraform.lock.hcl' -delete 2>/dev/null || true"""

# =============================================================================
# Shell Aliases - Cluster-Specific kubectl
# =============================================================================

[tool_alias]
ks = "KUBECONFIG=~/.kube/config-stg kubectl"
kp = "KUBECONFIG=~/.kube/config-prod kubectl"

